---
phase: 02-runtime-encoding
plan: 05
type: tdd
wave: 4
depends_on: [02-03, 02-04]
files_modified:
  - tests/test_roundtrip.py
  - bitschema/__init__.py
autonomous: true

must_haves:
  truths:
    - "For all valid data, decode(encode(data)) == data"
    - "Round-trip works for all field types (bool, int, enum)"
    - "Round-trip works for nullable fields with None values"
    - "Round-trip works for mixed schemas with multiple field types"
    - "Hypothesis finds no counterexamples in property-based tests"
  artifacts:
    - path: "tests/test_roundtrip.py"
      provides: "Property-based round-trip tests with Hypothesis"
      min_lines: 100
      contains: "@given"
    - path: "bitschema/__init__.py"
      provides: "Complete Phase 2 API exports"
      exports: ["encode", "decode", "validate_data"]
  key_links:
    - from: "tests/test_roundtrip.py"
      to: "bitschema/encoder.py"
      via: "encode function"
      pattern: "encode\\("
    - from: "tests/test_roundtrip.py"
      to: "bitschema/decoder.py"
      via: "decode function"
      pattern: "decode\\("
    - from: "tests/test_roundtrip.py"
      to: "hypothesis"
      via: "Property-based test strategies"
      pattern: "@given.*st\\."
---

<objective>
Verify round-trip correctness with property-based tests using Hypothesis.

Purpose: Implements DECODE-05 requirement by testing that encode(decode(x)) == x for all valid inputs, using Hypothesis to automatically generate edge cases and field combinations.

Output: Comprehensive round-trip test suite with Hypothesis strategies, complete Phase 2 API surface in __init__.py, verification that encoding is reversible.
</objective>

<execution_context>
@/Users/rbrandes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rbrandes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-runtime-encoding/02-RESEARCH.md
@.planning/phases/02-runtime-encoding/02-03-SUMMARY.md
@.planning/phases/02-runtime-encoding/02-04-SUMMARY.md

From research (Pattern 5: Round-Trip Testing):
- Use Hypothesis @given decorator with strategies
- Generate valid values for each field type
- Test decode(encode(data)) == data invariant
- Test edge cases: min/max values, None for nullable, boundary conditions

From 02-03 and 02-04:
- encode and decode functions available
- All field types supported (bool, int, enum)
- Nullable fields supported
</context>

<feature>
  <name>Round-trip correctness verification with Hypothesis</name>
  <files>
    tests/test_roundtrip.py
    bitschema/__init__.py
  </files>
  <behavior>
    Property-based tests verify round-trip invariant:
    - For all valid boolean values: decode(encode({"b": v})) == {"b": v}
    - For all valid integer values: decode(encode({"i": v})) == {"i": v}
    - For all valid enum values: decode(encode({"e": v})) == {"e": v}
    - For nullable fields with None: decode(encode({"x": None})) == {"x": None}
    - For complex schemas with multiple fields: full round-trip preserves all values

    Hypothesis strategies:
    - st.booleans() for bool fields
    - st.integers(min_value=min, max_value=max) for int fields
    - st.sampled_from(values) for enum fields
    - st.none() | st.integers(...) for nullable int fields

    Test cases:
    - Single bool field round-trip with all values
    - Single int field round-trip with min, max, random values
    - Single enum field round-trip with all enum values
    - Nullable field round-trip with None and values
    - Multi-field schema round-trip (bool + int + enum)
    - Edge case: all fields at max value (test bit packing boundaries)
    - Edge case: negative int ranges round-trip correctly
  </behavior>
  <implementation>
    1. Create tests/test_roundtrip.py with Hypothesis imports
    2. Create helper: generate_value_strategy(layout: FieldLayout) returns Hypothesis strategy
    3. Write @given test for single bool field round-trip
    4. Write @given test for single int field round-trip (boundary values)
    5. Write @given test for single enum field round-trip
    6. Write @given test for nullable field round-trip
    7. Write @given test for multi-field schema round-trip
    8. Update bitschema/__init__.py to export encode, decode, validate_data, EncodingError
    9. Add integration test: load schema from file → compute layout → encode → decode → verify
  </implementation>
</feature>

<verification>
Run tests:
```bash
cd /Users/rbrandes/Documents/private/private-projects/BitSchema
pytest tests/test_roundtrip.py -v --hypothesis-show-statistics
```

Verify:
- All property-based tests pass
- Hypothesis explores edge cases (min, max, 0, None)
- No counterexamples found
- Statistics show good example coverage
- Integration test verifies full pipeline works
</verification>

<success_criteria>
- Round-trip tests pass for all field types
- Hypothesis property-based tests find no counterexamples
- Nullable field round-trip preserves None values
- Multi-field schemas round-trip correctly
- Integration test verifies end-to-end pipeline (file → encode → decode)
- Complete Phase 2 API exported from bitschema package
- All tests pass with 100+ examples per property test
</success_criteria>

<output>
After completion, create `.planning/phases/02-runtime-encoding/02-05-SUMMARY.md` following the summary template with:
- TDD cycle commits (RED: failing tests, GREEN: implementation if needed)
- Round-trip test suite with Hypothesis
- Property-based test strategies for all field types
- Integration test covering full pipeline
- Phase 2 complete: runtime encoding/decoding operational
</output>
