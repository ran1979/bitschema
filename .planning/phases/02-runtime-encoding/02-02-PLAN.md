---
phase: 02-runtime-encoding
plan: 02
type: tdd
wave: 2
depends_on: [02-01]
files_modified:
  - bitschema/validator.py
  - bitschema/errors.py
  - tests/test_validator.py
autonomous: true

must_haves:
  truths:
    - "Validator checks all required fields are present in data dict"
    - "Validator checks field values match expected types"
    - "Validator checks values are within min/max constraints"
    - "Validator fails fast with clear error messages including field name and violated constraint"
  artifacts:
    - path: "bitschema/validator.py"
      provides: "Runtime value validation functions"
      exports: ["validate_data", "validate_field_value"]
      min_lines: 50
    - path: "bitschema/errors.py"
      provides: "EncodingError exception class"
      contains: "EncodingError"
  key_links:
    - from: "tests/test_validator.py"
      to: "bitschema/validator.py"
      via: "pytest tests validate error conditions"
      pattern: "pytest\\.raises.*EncodingError"
---

<objective>
Create runtime value validation module for encoding preparation.

Purpose: Implements ENCODE-02, ENCODE-03, ENCODE-04 requirements by validating data dict before encoding to prevent silent corruption and provide clear error messages.

Output: Validation module with validate_data and validate_field_value functions, EncodingError exception with context, comprehensive tests for all constraint types.
</objective>

<execution_context>
@/Users/rbrandes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rbrandes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-runtime-encoding/02-RESEARCH.md
@.planning/phases/02-runtime-encoding/02-01-SUMMARY.md

From research:
- Fail-fast validation pattern (validate before any bit operations)
- EncodingError with field_name and message attributes
- Validate: required fields present, type correctness, constraint satisfaction

From 02-01:
- FieldLayout has nullable flag
- Schema validation already handles schema-level constraints
</context>

<feature>
  <name>Runtime data validation module</name>
  <files>
    bitschema/validator.py
    bitschema/errors.py
    tests/test_validator.py
  </files>
  <behavior>
    validate_data(data: dict, layouts: list[FieldLayout]) validates complete data dict:
    - All required (non-nullable) fields present (ENCODE-02)
    - Each field value passes validate_field_value
    - Raises EncodingError with clear message on failure

    validate_field_value(value: Any, layout: FieldLayout) validates single field:
    - Type correctness (bool is bool, int is int, enum value in values list)
    - Constraint satisfaction (int within min/max, enum in allowed values)
    - None allowed only for nullable fields
    - Raises EncodingError(field_name, message) on violation (ENCODE-04)

    Test cases:
    - Missing required field → EncodingError with field name
    - Wrong type (str for int) → EncodingError with type mismatch
    - Int below min → EncodingError with value and min
    - Int above max → EncodingError with value and max
    - Enum invalid value → EncodingError with value and allowed list
    - None for non-nullable → EncodingError
    - None for nullable → passes
    - All valid → no error
  </behavior>
  <implementation>
    1. Add EncodingError to bitschema/errors.py (similar to ValidationError with field_name attribute)
    2. Create bitschema/validator.py with validate_data and validate_field_value
    3. validate_data checks required fields present (set difference)
    4. validate_field_value implements type-specific validation (bool/int/enum)
    5. Include field name, value, and constraint in all error messages
    6. Update bitschema/__init__.py to export validate_data and EncodingError
  </implementation>
</feature>

<verification>
Run tests:
```bash
cd /Users/rbrandes/Documents/private/private-projects/BitSchema
pytest tests/test_validator.py -v
```

Verify:
- Missing field detection with clear message
- Type validation for bool, int, enum
- Constraint validation (min/max for int, values for enum)
- Nullable field handling (None accepted for nullable, rejected for non-nullable)
- Error messages include field name and violated constraint
</verification>

<success_criteria>
- EncodingError exception class with field_name attribute
- validate_data function checks all required fields present
- validate_field_value validates type and constraints
- Clear error messages with field name, value, and constraint
- Tests cover all field types, constraint violations, nullable handling
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-runtime-encoding/02-02-SUMMARY.md` following the summary template with:
- TDD cycle commits (RED: failing tests, GREEN: implementation)
- EncodingError exception class
- Validation functions for data dict and individual fields
- Test coverage for all validation scenarios
</output>
