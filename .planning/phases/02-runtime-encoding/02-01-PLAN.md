---
phase: 02-runtime-encoding
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - bitschema/models.py
  - bitschema/layout.py
  - tests/test_models.py
  - tests/test_layout.py
autonomous: true

must_haves:
  truths:
    - "Schema can define nullable fields with nullable=True flag"
    - "Nullable fields add 1 bit for presence tracking"
    - "Layout computation accounts for presence bit in total_bits"
  artifacts:
    - path: "bitschema/models.py"
      provides: "Nullable flag on field definitions"
      contains: "nullable"
    - path: "bitschema/layout.py"
      provides: "Presence bit calculation for nullable fields"
      contains: "nullable"
  key_links:
    - from: "bitschema/models.py"
      to: "bitschema/layout.py"
      via: "nullable attribute on FieldLayout"
      pattern: "nullable.*=.*True"
---

<objective>
Extend schema models to support nullable fields with presence bit tracking.

Purpose: Enables TYPE-06 requirement (nullable fields with presence bit) by adding nullable flag to field definitions and updating bit layout computation to add 1 bit for presence tracking.

Output: Schema models support nullable=True flag, layout computation adds presence bit, tests verify bit count increases by 1 for nullable fields.
</objective>

<execution_context>
@/Users/rbrandes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rbrandes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-runtime-encoding/02-RESEARCH.md

Phase 1 established:
- Schema models with Pydantic validation (IntFieldDefinition, BoolFieldDefinition, EnumFieldDefinition)
- Layout computation with FieldLayout dataclass
- Bit width calculation for each field type
</context>

<feature>
  <name>Nullable field support in schema models</name>
  <files>
    bitschema/models.py
    bitschema/layout.py
    tests/test_models.py
    tests/test_layout.py
  </files>
  <behavior>
    Schema fields can have optional nullable=True flag (defaults to False).
    When nullable=True, layout computation adds 1 bit for presence tracking.

    Test cases:
    - Non-nullable bool field: 1 bit total
    - Nullable bool field: 2 bits total (1 presence + 1 value)
    - Nullable int(min=0, max=127): 8 bits total (1 presence + 7 value)
    - Schema with mix of nullable and non-nullable: correct total_bits

    Round-trip schema validation: nullable flag preserved through dict → model → dict
  </behavior>
  <implementation>
    1. Add nullable: bool = False field to all field definition models (Int, Bool, Enum)
    2. Update FieldLayout to include nullable: bool attribute
    3. Modify compute_bit_layout to check nullable flag and add 1 to bits for nullable fields
    4. Update FieldLayout creation to copy nullable flag from field definition
    5. Verify 64-bit limit validation includes presence bits
  </implementation>
</feature>

<verification>
Run tests:
```bash
cd /Users/rbrandes/Documents/private/private-projects/BitSchema
pytest tests/test_models.py tests/test_layout.py -v
```

Verify:
- Nullable flag appears in schema dict representation
- Nullable fields have bits = field_bits + 1
- Total bit calculation includes presence bits
- 64-bit limit validation accounts for presence bits
</verification>

<success_criteria>
- All field definition models accept nullable parameter
- Layout computation correctly adds presence bit for nullable fields
- Tests verify nullable bool (2 bits), nullable int (bits + 1), mixed schemas
- Schema serialization preserves nullable flag
- 64-bit limit validation includes presence bits in total
</success_criteria>

<output>
After completion, create `.planning/phases/02-runtime-encoding/02-01-SUMMARY.md` following the summary template with:
- TDD cycle commits (RED: failing tests, GREEN: implementation)
- Nullable flag on all field definitions
- Layout computation with presence bit logic
- Test coverage for nullable field bit counting
</output>
