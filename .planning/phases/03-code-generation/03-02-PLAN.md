---
phase: 03-code-generation
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - bitschema/jsonschema.py
  - tests/test_jsonschema.py
  - bitschema/__init__.py
autonomous: true

must_haves:
  truths:
    - "Exported JSON Schema validates against JSON Schema Draft 2020-12 spec"
    - "Field type mappings are correct (boolean → boolean, integer → integer with min/max, enum → string with enum values)"
    - "Nullable fields map to type arrays ['integer', 'null']"
    - "Required array contains all non-nullable fields"
    - "Schema includes all mandatory fields ($schema, type, properties)"
  artifacts:
    - path: "bitschema/jsonschema.py"
      provides: "JSON Schema Draft 2020-12 export"
      exports: ["generate_json_schema"]
      min_lines: 80
    - path: "tests/test_jsonschema.py"
      provides: "JSON Schema export tests"
      exports: []
      min_lines: 100
  key_links:
    - from: "bitschema/jsonschema.py"
      to: "bitschema/models.py"
      via: "reads field definitions to map types"
      pattern: "BoolFieldDefinition|IntFieldDefinition|EnumFieldDefinition"
    - from: "tests/test_jsonschema.py"
      to: "jsonschema library"
      via: "validates exported schema against Draft 2020-12"
      pattern: "jsonschema\\.validate|Draft202012Validator"
---

<objective>
Export BitSchema schemas to JSON Schema Draft 2020-12 format for ecosystem integration

Purpose: Enables interoperability with JSON Schema tooling, API documentation generators, and validation libraries. Provides standard format for schema exchange.

Output: JSON Schema export function producing Draft 2020-12 compliant schemas that accurately represent BitSchema field types and constraints.
</objective>

<execution_context>
@/Users/rbrandes/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rbrandes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-generation/03-RESEARCH.md

# Existing components
@bitschema/models.py
@bitschema/layout.py
</context>

<feature>
  <name>JSON Schema Export</name>
  <files>
    bitschema/jsonschema.py
    tests/test_jsonschema.py
  </files>
  <behavior>
    Generate JSON Schema Draft 2020-12 compliant dict from BitSchema.

    Input: BitSchema, list[FieldLayout]
    Output: dict with JSON Schema structure:
      {
        "$schema": "https://json-schema.org/draft/2020-12/schema",
        "$id": "https://example.com/schemas/{name}.schema.json",
        "type": "object",
        "title": "{schema.name}",
        "description": "BitSchema-generated schema",
        "properties": {
          "field_name": {"type": "boolean"} | {"type": "integer", "minimum": x, "maximum": y} | {"type": "string", "enum": [...]}
        },
        "required": ["non_nullable_field1", ...],
        "additionalProperties": false,
        "x-bitschema-version": "1",
        "x-bitschema-total-bits": N
      }

    Field type mappings:
      - BoolFieldDefinition → {"type": "boolean"}
      - IntFieldDefinition → {"type": "integer", "minimum": min, "maximum": max}
      - EnumFieldDefinition → {"type": "string", "enum": [values]}
      - Nullable boolean → {"type": ["boolean", "null"]}
      - Nullable integer → {"type": ["integer", "null"], "minimum": ..., "maximum": ...}
      - Nullable enum → {"type": ["string", "null"], "enum": [values + [null]]}

    Test cases:
      - Boolean field → {"type": "boolean"}
      - Integer field with min/max → {"type": "integer", "minimum": 0, "maximum": 100}
      - Enum field → {"type": "string", "enum": ["red", "green", "blue"]}
      - Nullable boolean → {"type": ["boolean", "null"]}
      - Nullable integer → type array with constraints
      - Non-nullable fields → appear in "required" array
      - Schema includes all mandatory Draft 2020-12 fields
      - Generated schema validates with jsonschema library
  </behavior>
  <implementation>
    Structure:
    1. generate_json_schema(schema: BitSchema, layouts: list[FieldLayout]) → dict
       - Build base schema dict with $schema, $id, type, title, description
       - Add x-bitschema-* metadata (version, total_bits)
       - Iterate schema.fields to build properties dict
       - Build required array from non-nullable fields
       - Set additionalProperties: false

    2. map_field_to_json_schema(field_name: str, field_def: FieldDefinition) → dict
       - Check isinstance(field_def, BoolFieldDefinition) → {"type": "boolean"} or ["boolean", "null"]
       - Check isinstance(field_def, IntFieldDefinition) → {"type": "integer", "minimum": ..., "maximum": ...}
       - Check isinstance(field_def, EnumFieldDefinition) → {"type": "string", "enum": [...]}
       - Add nullable handling for all types (type becomes array)

    3. Optional: validate_json_schema(schema_dict: dict) → bool
       - Use jsonschema library to validate against Draft 2020-12 meta-schema
       - Return True if valid, raise exception otherwise

    Dependencies:
    - Add jsonschema to dev dependencies (for validation in tests)
    - pip install jsonschema (optional, graceful fallback)

    RED phase tests:
    - test_boolean_field_mapping
    - test_integer_field_with_constraints
    - test_enum_field_mapping
    - test_nullable_boolean_mapping
    - test_nullable_integer_mapping
    - test_required_array_includes_non_nullable
    - test_schema_includes_mandatory_fields
    - test_schema_validates_against_draft_2020_12
    - test_custom_metadata_fields

    GREEN phase implementation:
    - Implement generate_json_schema function
    - Map all field types correctly
    - Handle nullable type arrays
    - Validate output with jsonschema library
  </implementation>
</feature>

<verification>
Run test suite:
```bash
pytest tests/test_jsonschema.py -v
```

Should see:
- All field type mapping tests pass
- Required array test passes
- Schema validation test passes (validates against Draft 2020-12 meta-schema)
- Metadata fields test passes
</verification>

<success_criteria>
1. generate_json_schema() produces valid JSON Schema Draft 2020-12
2. All field types map correctly to JSON Schema types
3. Nullable fields use type arrays ["type", "null"]
4. Required array contains all non-nullable field names
5. Schema includes all mandatory fields ($schema, type, properties)
6. Custom metadata fields (x-bitschema-*) are present
7. Generated schema validates with jsonschema library
8. All tests pass (9+ test cases covering all field types and edge cases)
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-generation/03-02-SUMMARY.md`

Follow TDD workflow:
- RED phase: Write failing tests, commit with "test(03-02): ..."
- GREEN phase: Implement to pass tests, commit with "feat(03-02): ..."
- REFACTOR phase (if needed): Clean up code, commit with "refactor(03-02): ..."
</output>
